<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="IotDashboard.App.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:IotDashboard.App"
    xmlns:models="using:IotDashboard.Core.Models"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Title="IoT Dashboard">

    <Window.SystemBackdrop>
        <MicaBackdrop />
    </Window.SystemBackdrop>

    <Grid x:Name="RootGrid">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <Grid Grid.Row="0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Padding="16,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                <FontIcon Glyph="&#xE968;" FontSize="24" Foreground="{ThemeResource AccentFillColorDefaultBrush}"/>
                <TextBlock Text="IoT Device Dashboard" 
                          VerticalAlignment="Center"
                          Style="{ThemeResource TitleTextBlockStyle}"/>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                <ComboBox x:Name="PortComboBox"
                         PlaceholderText="Select Port"
                         ItemsSource="{x:Bind ViewModel.AvailablePorts}"
                         SelectedItem="{x:Bind ViewModel.SelectedPort, Mode=TwoWay}"
                         Width="120"
                         IsEnabled="{Binding DataContext.ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource BoolNegationConverter}, ElementName=RootGrid}"/>
                
                <Button Content="Refresh" 
                       Command="{x:Bind ViewModel.RefreshPortsCommand}"
                       IsEnabled="{Binding DataContext.ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource BoolNegationConverter}, ElementName=RootGrid}"/>
                
                <Button x:Name="ConnectButton"
                       Content="{Binding DataContext.ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource ConnectButtonTextConverter}, ElementName=RootGrid}"
                       Command="{x:Bind ViewModel.ConnectCommand}"
                       Style="{ThemeResource AccentButtonStyle}"/>
            </StackPanel>
        </Grid>

        <!-- Main Content -->
        <ScrollViewer Grid.Row="1" Padding="16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Sensor Data Card -->
                <Border Grid.Row="0" Grid.Column="0" 
                       Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                       BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                       BorderThickness="1"
                       CornerRadius="8"
                       Padding="16"
                       Margin="0,0,8,16">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Environmental Sensors" 
                                  Style="{ThemeResource SubtitleTextBlockStyle}"/>
                        
                        <StackPanel Spacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE7C1;" FontSize="20" Foreground="#FF5722"/>
                                <TextBlock Text="Temperature" VerticalAlignment="Center"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{x:Bind ViewModel.Temperature, Mode=OneWay}" 
                                          Style="{ThemeResource TitleLargeTextBlockStyle}"
                                          Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                                <TextBlock Text="°C" 
                                          VerticalAlignment="Bottom"
                                          Margin="0,0,0,4"/>
                            </StackPanel>
                        </StackPanel>

                        <StackPanel Spacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE753;" FontSize="20" Foreground="#2196F3"/>
                                <TextBlock Text="Humidity" VerticalAlignment="Center"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{x:Bind ViewModel.Humidity, Mode=OneWay}" 
                                          Style="{ThemeResource TitleLargeTextBlockStyle}"
                                          Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                                <TextBlock Text="%" 
                                          VerticalAlignment="Bottom"
                                          Margin="0,0,0,4"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Device Status Card -->
                <Border Grid.Row="0" Grid.Column="1" 
                       Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                       BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                       BorderThickness="1"
                       CornerRadius="8"
                       Padding="16"
                       Margin="8,0,0,16">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Device Status" 
                                  Style="{ThemeResource SubtitleTextBlockStyle}"/>
                        
                        <StackPanel Spacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Ellipse Width="12" Height="12" 
                                        Fill="{Binding DataContext.ViewModel.IsOnline, Mode=OneWay, Converter={StaticResource OnlineStatusColorConverter}, ElementName=RootGrid}"
                                        VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding DataContext.ViewModel.IsOnline, Mode=OneWay, Converter={StaticResource OnlineStatusTextConverter}, ElementName=RootGrid}" 
                                          VerticalAlignment="Center"/>
                            </StackPanel>
                        </StackPanel>

                        <StackPanel Spacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE83F;" FontSize="20"/>
                                <TextBlock Text="Battery Level" VerticalAlignment="Center"/>
                            </StackPanel>
                            <ProgressBar Value="{x:Bind ViewModel.BatteryLevel, Mode=OneWay}" 
                                        Maximum="100"
                                        Foreground="{Binding DataContext.ViewModel.BatteryLevel, Mode=OneWay, Converter={StaticResource BatteryColorConverter}, ElementName=RootGrid}"/>
                            <TextBlock Text="{Binding DataContext.ViewModel.BatteryLevel, Mode=OneWay, Converter={StaticResource BatteryLevelTextConverter}, ElementName=RootGrid}" 
                                      Style="{ThemeResource CaptionTextBlockStyle}"/>
                        </StackPanel>

                        <StackPanel Spacing="4">
                            <TextBlock Text="Last Update" 
                                      Style="{ThemeResource CaptionTextBlockStyle}"
                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                            <TextBlock Text="{x:Bind ViewModel.LastUpdate, Mode=OneWay}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Light Control Card -->
                <Border Grid.Row="1" Grid.Column="0" 
                       Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                       BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                       BorderThickness="1"
                       CornerRadius="8"
                       Padding="16"
                       Margin="0,0,8,16">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Light Control" 
                                  Style="{ThemeResource SubtitleTextBlockStyle}"/>
                        
                        <StackPanel Spacing="12">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <FontIcon Glyph="{Binding DataContext.ViewModel.LightOn, Mode=OneWay, Converter={StaticResource LightIconConverter}, ElementName=RootGrid}" 
                                         FontSize="48"
                                         Foreground="{Binding DataContext.ViewModel.LightOn, Mode=OneWay, Converter={StaticResource LightColorConverter}, ElementName=RootGrid}"/>
                                <StackPanel VerticalAlignment="Center" Spacing="4">
                                    <TextBlock Text="{Binding DataContext.ViewModel.LightOn, Mode=OneWay, Converter={StaticResource LightStatusTextConverter}, ElementName=RootGrid}" 
                                              Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                                    <TextBlock Text="Smart Light" 
                                              Style="{ThemeResource CaptionTextBlockStyle}"
                                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                </StackPanel>
                            </StackPanel>
                            
                            <ToggleButton x:Name="LightToggle"
                                         Content="{Binding DataContext.ViewModel.LightOn, Mode=OneWay, Converter={StaticResource LightButtonTextConverter}, ElementName=RootGrid}"
                                         IsChecked="{x:Bind ViewModel.LightOn, Mode=OneWay}"
                                         Command="{x:Bind ViewModel.ToggleLightCommand}"
                                         IsEnabled="{x:Bind ViewModel.IsConnected, Mode=OneWay}"
                                         HorizontalAlignment="Stretch"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Fan Control Card -->
                <Border Grid.Row="1" Grid.Column="1" 
                       Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                       BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                       BorderThickness="1"
                       CornerRadius="8"
                       Padding="16"
                       Margin="8,0,0,16">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Fan Control" 
                                  Style="{ThemeResource SubtitleTextBlockStyle}"/>
                        
                        <StackPanel Spacing="12">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <FontIcon Glyph="&#xE90C;" 
                                         FontSize="48"
                                         Foreground="{ThemeResource AccentFillColorDefaultBrush}"/>
                                <StackPanel VerticalAlignment="Center" Spacing="4">
                                    <TextBlock Text="{Binding DataContext.ViewModel.FanSpeed, Mode=OneWay, Converter={StaticResource FanSpeedTextConverter}, ElementName=RootGrid}" 
                                              Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                                    <TextBlock Text="Smart Fan" 
                                              Style="{ThemeResource CaptionTextBlockStyle}"
                                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                </StackPanel>
                            </StackPanel>
                            
                            <Slider x:Name="FanSpeedSlider"
                                   Header="Speed"
                                   Minimum="0"
                                   Maximum="100"
                                   Value="{x:Bind ViewModel.FanSpeed, Mode=TwoWay}"
                                   IsEnabled="{x:Bind ViewModel.IsConnected, Mode=OneWay}"
                                   ThumbToolTipValueConverter="{StaticResource FanSpeedTooltipConverter}"/>
                            
                            <Button Content="Apply Speed"
                                   Command="{x:Bind ViewModel.UpdateFanSpeedCommand}"
                                   IsEnabled="{x:Bind ViewModel.IsConnected, Mode=OneWay}"
                                   HorizontalAlignment="Stretch"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Communication Log Section -->
                <Border Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2"
                       Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                       BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                       BorderThickness="1"
                       CornerRadius="8"
                       Padding="16"
                       Margin="0,0,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Sent Commands Panel -->
                        <StackPanel Grid.Column="0" Spacing="8" Margin="0,0,8,0">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE72A;" FontSize="20" Foreground="#4CAF50"/>
                                <TextBlock Text="发送的指令 (Sent Commands)" 
                                          Style="{ThemeResource SubtitleTextBlockStyle}"/>
                            </StackPanel>
                            
                            <Border Background="{ThemeResource LayerFillColorDefaultBrush}"
                                   BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                   BorderThickness="1"
                                   CornerRadius="4"
                                   Height="300">
                                <ScrollViewer>
                                    <ItemsControl ItemsSource="{x:Bind ViewModel.SentCommands, Mode=OneWay}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate x:DataType="models:CommunicationLogEntry">
                                                <Border Padding="8,4" 
                                                       BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                                                       BorderThickness="0,0,0,1">
                                                    <StackPanel Spacing="4">
                                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                                            <TextBlock Text="{x:Bind TimeString}" 
                                                                      Style="{ThemeResource CaptionTextBlockStyle}"
                                                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                                      Width="80"/>
                                                            <TextBlock Text="{x:Bind Description}" 
                                                                      Style="{ThemeResource BodyTextBlockStyle}"
                                                                      TextWrapping="Wrap"/>
                                                        </StackPanel>
                                                        <TextBlock Text="{x:Bind HexString}" 
                                                                  Style="{ThemeResource CaptionTextBlockStyle}"
                                                                  Foreground="#4CAF50"
                                                                  FontFamily="Consolas"
                                                                  TextWrapping="Wrap"
                                                                  Margin="88,0,0,0"/>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </Border>
                        </StackPanel>

                        <!-- Received Data Panel -->
                        <StackPanel Grid.Column="1" Spacing="8" Margin="8,0,0,0">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE896;" FontSize="20" Foreground="#2196F3"/>
                                <TextBlock Text="接收的数据 (Received Data)" 
                                          Style="{ThemeResource SubtitleTextBlockStyle}"/>
                            </StackPanel>
                            
                            <Border Background="{ThemeResource LayerFillColorDefaultBrush}"
                                   BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                   BorderThickness="1"
                                   CornerRadius="4"
                                   Height="300">
                                <ScrollViewer>
                                    <ItemsControl ItemsSource="{x:Bind ViewModel.ReceivedData, Mode=OneWay}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate x:DataType="models:CommunicationLogEntry">
                                                <Border Padding="8,4" 
                                                       BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                                                       BorderThickness="0,0,0,1">
                                                    <StackPanel Spacing="4">
                                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                                            <TextBlock Text="{x:Bind TimeString}" 
                                                                      Style="{ThemeResource CaptionTextBlockStyle}"
                                                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                                      Width="80"/>
                                                            <TextBlock Text="{x:Bind Description}" 
                                                                      Style="{ThemeResource BodyTextBlockStyle}"
                                                                      TextWrapping="Wrap"/>
                                                        </StackPanel>
                                                        <TextBlock Text="{x:Bind HexString}" 
                                                                  Style="{ThemeResource CaptionTextBlockStyle}"
                                                                  Foreground="#2196F3"
                                                                  FontFamily="Consolas"
                                                                  TextWrapping="Wrap"
                                                                  Margin="88,0,0,0"/>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </Border>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </ScrollViewer>

        <!-- Status Bar -->
        <Border Grid.Row="2" 
               Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
               BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
               BorderThickness="0,1,0,0"
               Padding="16,8">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <FontIcon Glyph="&#xE946;" FontSize="16" VerticalAlignment="Center"/>
                <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}" 
                          VerticalAlignment="Center"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
