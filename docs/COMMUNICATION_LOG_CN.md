# 通讯日志功能说明

## 功能概述

IoT Dashboard 现在包含了实时通讯日志显示功能，可以让用户清晰地看到应用程序与 Arduino 设备之间的所有通讯数据。这对于学习串口通讯协议和调试设备连接非常有帮助。

## 界面布局

通讯日志分为两个独立的面板显示在主界面底部：

### 📤 发送的指令 (Sent Commands)
- 位置：左侧面板（绿色标识）
- 内容：显示从应用程序发送到 Arduino 设备的所有指令
- 包含信息：
  - 时间戳（精确到毫秒）
  - 指令描述（如"Set Light ON"、"Request Device State"等）
  - 十六进制原始数据（如 `AA 02 02 01 01 55`）

### 📥 接收的数据 (Received Data)
- 位置：右侧面板（蓝色标识）
- 内容：显示从 Arduino 设备接收的所有响应数据
- 包含信息：
  - 时间戳（精确到毫秒）
  - 数据描述（解析后的传感器数值、状态信息等）
  - 十六进制原始数据

## 使用示例

### 1. 连接设备
当你点击"Connect"按钮连接到 Arduino 设备时，你会看到：

**发送：**
```
13:45:23.456  Request Device State
              AA 01 01 00 55
```

**接收：**
```
13:45:23.478  State: Temp=23°C, Humid=55%, Light=0, Fan=0%, Online=1, Batt=85%
              AA 07 01 17 37 00 00 01 55 55
```

### 2. 控制灯光
当你点击"Turn On"打开灯光时：

**发送：**
```
13:46:10.123  Set Light ON
              AA 02 02 01 01 55
```

**接收：**
```
13:46:10.145  Light Confirmed: ON
              AA 07 01 17 37 01 00 01 55 55
```

### 3. 调节风扇速度
当你设置风扇速度为 60% 时：

**发送：**
```
13:47:05.789  Set Fan Speed to 60%
              AA 02 03 3C 3F 55
```

**接收：**
```
13:47:05.812  Fan Speed Confirmed: 60%
              AA 07 01 17 37 01 3C 01 55 55
```

## 协议格式说明

每个数据包的格式：
```
[起始字节][长度][类型][数据...][校验和][结束字节]
[  0xAA  ][ 1B ][ 1B ][  变长 ][  1B  ][ 0x55 ]
```

### 字段解释

| 字段 | 大小 | 说明 | 示例 |
|------|------|------|------|
| 起始字节 | 1 字节 | 固定为 0xAA | AA |
| 长度 | 1 字节 | Type + Data 的字节数 | 02 |
| 类型 | 1 字节 | 命令类型（见下表） | 02 |
| 数据 | 变长 | 命令参数或响应数据 | 01 |
| 校验和 | 1 字节 | XOR 校验（Length^Type^Data...） | 01 |
| 结束字节 | 1 字节 | 固定为 0x55 | 55 |

### 命令类型

| 类型代码 | 十六进制 | 命令名称 | 说明 |
|---------|---------|---------|------|
| 1 | 0x01 | GET_STATE | 获取设备完整状态 |
| 2 | 0x02 | SET_LIGHT | 设置灯光开关 |
| 3 | 0x03 | SET_FAN_SPEED | 设置风扇速度 |
| 4 | 0x04 | GET_SENSOR_DATA | 获取传感器数据 |
| 5 | 0x05 | RESET | 重置设备 |
| 6 | 0x06 | HEARTBEAT | 心跳包 |

## 实例分析

### 完整通讯流程示例

假设你要打开灯光，完整的通讯过程如下：

1. **用户操作**：点击"Turn On"按钮

2. **应用发送命令**：
   ```
   十六进制: AA 02 02 01 01 55
   解析：
   - AA: 起始字节
   - 02: 长度 (Type 1字节 + Data 1字节 = 2)
   - 02: SET_LIGHT 命令
   - 01: 数据 = 1 (打开)
   - 01: 校验和 (02 XOR 02 XOR 01 = 01)
   - 55: 结束字节
   ```

3. **Arduino 接收并处理**：
   - 验证起始/结束字节
   - 验证校验和
   - 打开 LED（Pin 8）
   - 准备状态响应

4. **Arduino 发送响应**：
   ```
   十六进制: AA 07 01 17 37 01 00 01 55 55
   解析：
   - AA: 起始字节
   - 07: 长度 (1 + 6 = 7)
   - 01: GET_STATE 响应
   - 17: 温度 = 23°C
   - 37: 湿度 = 55%
   - 01: 灯光 = 1 (开启)
   - 00: 风扇速度 = 0%
   - 01: 在线 = 1
   - 55: 电池 = 85%
   - (校验和)
   - 55: 结束字节
   ```

5. **应用接收并显示**：
   - UI 更新灯光状态为"ON"
   - 通讯日志记录完整交互

## 学习建议

### 对于初学者

1. **观察自动心跳**：连接设备后，每 2 秒会自动发送一次 GET_STATE 请求，观察这个规律的通讯模式

2. **手动操作对比**：
   - 先观察心跳的数据包格式
   - 然后手动控制灯光或风扇
   - 对比不同命令的数据包结构

3. **理解校验和**：
   - 选择一个简单的命令（如 Heartbeat）
   - 手动计算校验和：Length XOR Type XOR Data...
   - 验证与实际发送的是否一致

### 对于进阶学习

1. **协议扩展**：
   - 研究如何添加新的命令类型
   - 设计自己的数据格式
   - 实现新的传感器支持

2. **错误处理**：
   - 故意修改数据包（如改变校验和）
   - 观察系统如何处理错误的数据包
   - 学习健壮的协议设计

3. **性能分析**：
   - 观察请求-响应的延迟
   - 分析不同命令的执行时间
   - 优化通讯频率

## 日志管理

- **自动限制**：每个面板最多保留最近 50 条记录，自动删除旧记录
- **实时更新**：新消息会显示在列表顶部
- **清除日志**：断开设备连接时，日志会保留，重新连接会继续追加

## 故障排查

### 看不到通讯数据？
- 确保设备已连接（状态栏显示"Connected to COMx"）
- 检查 Arduino 是否正确烧录了固件
- 尝试手动点击控制按钮触发通讯

### 数据显示乱码？
- 检查串口波特率是否为 115200
- 确认 Arduino 固件版本与应用程序协议版本匹配
- 重新连接设备

### 只有发送没有接收？
- Arduino 可能未正确响应，检查串口连接
- 查看 Arduino IDE 的串口监视器确认设备在线
- 检查硬件连接（USB 线缆）

## 技术实现

如果你想了解代码实现，参考以下文件：

- **模型定义**：`IotDashboard.Core/Models/CommunicationLogEntry.cs`
- **日志事件**：`IotDashboard.Core/Services/DeviceController.cs`
- **UI 绑定**：`IotDashboard.App/ViewModels/MainViewModel.cs`
- **界面显示**：`IotDashboard.App/MainWindow.xaml`

## 相关文档

- [协议完整文档](PROTOCOL.md) - 详细的协议规范
- [Arduino 设置](ARDUINO_SETUP.md) - 硬件配置指南
- [开发指南](DEVELOPMENT.md) - 扩展开发文档

---

**提示**：通讯日志是学习嵌入式通讯协议的绝佳工具，建议配合 Arduino IDE 的串口监视器一起使用，可以从两端同时观察数据流。
